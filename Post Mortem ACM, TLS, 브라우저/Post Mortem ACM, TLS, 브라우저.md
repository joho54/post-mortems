# Post Mortem: ACM, TLS, 브라우저  
  
개발자로서 실무를 하면서 가장 크게 스트레스 받는 장애 유형은 당연히 재현이 안 되는 오류들이다. 개발 서버에 나 빼고 접속이 안 되는 이슈 역시, 사용자에게는 아무 영향 없는 문제였지만, 내 컴퓨터에서는 재현이 되지 않아 당황했던 기억이 난다. 그나마 모바일로도 접속이 안 돼서 오직 내 데스크탑 브라우저에서만 접속이 된다는 사실을 알 수 있었다.   
  
전반적으로 원인을 정리하면 다음과 같다. AWS로 서버 마이그레이션 하며 도메인이 새로 바뀌었고, Amazon Certificate Manager 를 통해 새로운 도메인에 대한 인증서를 발급받아야 했다. 이때 도메인들은 아래와 같이 정했었다.   
  
Production  
백엔드: ecs.aiduapp.com  
학생 프론트엔드: aiduapp.com  
선생님 프론트엔드: teacher.aiduapp.com  
  
Development  
백엔드: dev.ecs.aiduapp.com  
학생 프론트: dev.aiduapp.com  
선생님 프론트: dev-teacher.aiduapp.com  
  
이 도메인을 결정하던 당시에는 TLS인증서에 지정한 도메인 와일드카드 *.aiduapp.com이 저 중에서 딱 하나, 개발 백엔드의 도메인은 커버해주지 못한다는 사실을 몰랐다.   
  
이로 인해서, 프론트엔드 서버는 모두 문제 없이 접속할 수 있었지만, 백엔드로 보내는 첫번째 요청, 로그인 시도부터 동료들의 컴퓨터에서 실패했다.  
  
이것이 실패한 이유는, 프론트에서 들이민 *.aiduapp.com TLS 인증서가 개발 백엔드 도메인에 맞지 않아 요청이 거부당했기 때문이다.  
  
좋다, 실패한 이유는 명확하다. 그러면 내 데스크탑에서는 왜 됐을까? 개발 서버를 구축한 초반에, 백엔드에 요청을 보낼 수 없다는 크롬 브라우저의 오류 페이지가 떴었다. 나는 그때 본능적으로 고급->인증서 없이 접속하기 버튼을 눌렀고 그로 인해서 백엔드로 자유롭게 요청을 보낼 수 있었다.   
  
일단 시간이 없다는 핑계로 “내가 왜 됐는지”를 확실히 검증하고 넘어가진 못해서 아쉽다. 그래서 위의 분석은 일단은 기억을 토대로 한 가설에 불과하다. 이를 검증하기 위해서는 이미 등록된 개발서버용 TLS 인증서를 다시 지우고, 개발 백엔드로 요청이 안 보내지는 상황에서 브라우저 설정을 뒤져 인증서 신뢰하기 버튼을 눌러 되는지 확인하면 되긴 한다. 나중에 시간 나면 해 봐야지…  
  
어쨌든 백엔드 호스트를 커버할 수 있는 TLS 인증서 발급 후 이 문제가 완벽히 해결됐기에 완벽한 검증은 하지 않았으나 사실상 검증 된 것으로 하고 넘어가기로 했다.   
  
궁금한 점  
1. 결국 TLS 인증서는 프론트엔드와 백엔드 두 서버에서 주고받는 인증서인가? 이번과 달리 프론트엔드 서버에 제대로 된 인증서가 없었다면, 브라우저에서부터 프론트 서버로 https 접속이 불가했을까?  
    1. 답변: TLS 인증서는 프론트엔드와 백엔드가 주고받지 않는다. TLS 인증서는 클라이언트 사이드와 프론트엔드, 백엔드 서버가 주고받는다. 만약 프론트엔드 서버에 제대로된 인증서가 없었다면 브라우저는 프론트엔드 서버를 신뢰할 수 없다고 경고를 띄우고 접속을 차단했을 것이다.)  
2. TLS 인증서가 도메인 네임과 달라서 HTTPS 요청을 거절하는 주체는 백엔드 서버인가? 프론트엔드에서 만약 HTTP 요청으로 바꿨다면?  
    1. 답변: TLS가 서버의 도메인 네임과 다르면 접속을 차단하는 주체는 클라이언트(브라우저)다. 서버가 내민 인증서를 실제 접속 시도한 도메인 이름과 비교하여 차단 여부를 결정한다(브라우저에 관련 차단 코드가 있을 것이다)   
3. 내가 인증서 없이 접속하기 버튼을 누른 것은 HTTP로 요청을 보내도록 바꾼 건가? TLS 인증서가 백엔드 서버에 대해 여전히 무효한데 어째서 클라이언트의 선택만으로 이 무효한 인증서를 통한 통신이 가능했던 거지?  
    1. 답변:  연결이 HTTP로 바뀌는 것이 아니고, 가짜 인증서일 가능성이 있음에도 불구하고 브라우저의 사용자에게 정말로 서버를 신뢰하고 접속할지 묻고, 신뢰한다고 하면 서버로 요청을 보내준 것이다. 완전히 브라우저의 결정 권한이므로 도메인 와일드카드가 무효한 인증서였음에도 백엔드 서버와의 통신이 가능했던 것이다.   
  
  
#회고  
  
  
